# generated by mBlock5 for CyberPi
# codes make you happy
import event, time, cyberpi

# Initialize sprite variables
line_1 = cyberpi.sprite()
line_2 = cyberpi.sprite()
line_4 = cyberpi.sprite()
line_3 = cyberpi.sprite()
picture_1 = cyberpi.sprite()
picture2 = cyberpi.sprite()

# Global variable initialization
num = 0

# --- Setup Functions ---
def location():
    """Sets the alignment and position for text sprites."""
    line_1.set_align("center")
    line_2.set_align("center")
    line_3.set_align("center")
    line_4.set_align("center")
    line_1.move_to(64, 35)
    line_2.move_to(64, 64)
    line_3.move_to(64, 96)
    line_4.move_to(64, 114)

def color():
    """Sets the background color and brush color for text sprites."""
    cyberpi.background.fill(0, 0, 0)
    line_1.set_brush(75, 175, 255)
    line_2.set_brush(75, 176, 255)
    line_3.set_brush(255, 255, 255)
    line_4.set_brush(255, 255, 255)

def size():
    """Sets the size for text sprites."""
    line_1.set_size(80)
    line_2.set_size(80)
    line_3.set_size(60)
    line_4.set_size(60)

# --- Screen Display Functions ---
def screen1():
    """Displays the initial screen based on the CyberPi's language setting."""
    if cyberpi.get_language() == 'chinese':
        line_1.draw_text('摇一摇')
        line_2.draw_text('发送礼物')
        line_3.draw_text('找到其他童芯派')
        line_4.draw_text('发礼物吧')
    else:
        line_1.draw_text('Shake it')
        line_2.draw_text('Send gifts')
        line_3.draw_text('Find a partner ')
        line_4.draw_text('to exchange gifts ')

def screen2_Chinese():
    """Displays the second screen with Chinese text and gift box pixel art."""
    line_3.hide()
    line_1.draw_text('【查收礼物】')
    line_2.draw_pixels([
        0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0xff0000,0x111111,0x111111,0xff0000,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x111111,0x111111,0x111111,0x111111,0xff0000,0xff0000,0xff0000,0xff0000,0xff0000,0xff0000,0x111111,0x111111,0x111111,0x111111,0x111111,
        0x111111,0xff0000,0xff0000,0x111111,0x111111,0xff0000,0xff0000,0xff0000,0xff0000,0x111111,0x111111,0xff0000,0xff0000,0x111111,0x111111,0x111111,
        0x111111,0x111111,0x111111,0xff0000,0xff0000,0xff0000,0xff0000,0xff0000,0xff0000,0xff0000,0xff0000,0x111111,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x2,0x2,0x2,0x2,0x2,0x2,0xff0000,0xff0000,0x2,0x2,0x2,0x2,0x2,0x2,0x111111,
        0x111111,0x2,0x2,0x2,0x2,0x2,0x2,0xff0000,0xff0000,0x2,0x2,0x2,0x2,0x2,0x2,0x111111,
        0x111111,0x111111,0x2,0x2,0x2,0x2,0x2,0xff0000,0xff0000,0x2,0x2,0x2,0x2,0x111111,0x111111,0x111111,
        0x111111,0x111111,0xffff00,0xffff00,0xffff00,0xffff00,0xff0000,0xff0000,0xffff00,0xffff00,0xffff00,0xffff00,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x111111,0xffff00,0xffff00,0xffff00,0xffff00,0xff0000,0xff0000,0xffff00,0xffff00,0xffff00,0xffff00,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x111111,0xffff00,0xffff00,0xffff00,0xffff00,0xff0000,0xff0000,0xffff00,0xffff00,0xffff00,0xffff00,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x111111,0xffff00,0xffff00,0xffff00,0xffff00,0xff0000,0xff0000,0xffff00,0xffff00,0xffff00,0xffff00,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x111111,0xffff00,0xffff00,0xffff00,0xffff00,0xff0000,0xff0000,0xffff00,0xffff00,0xffff00,0xffff00,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x111111,0xffff00,0xffff00,0xffff00,0xffff00,0xff0000,0xff0000,0xffff00,0xffff00,0xffff00,0xffff00,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111
    ])
    line_4.draw_text('按下 A 打开')
    line_2.set_size(400)
    cyberpi.screen.render()

def screen2_English():
    """Displays the second screen with English text and gift box pixel art."""
    line_3.hide()
    line_1.draw_text('【 Check it 】')
    line_2.draw_pixels([
        0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0xff0000,0x111111,0x111111,0xff0000,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x111111,0x111111,0x111111,0x111111,0xff0000,0xff0000,0xff0000,0xff0000,0xff0000,0xff0000,0x111111,0x111111,0x111111,0x111111,0x111111,
        0x111111,0xff0000,0xff0000,0x111111,0x111111,0xff0000,0xff0000,0xff0000,0xff0000,0x111111,0x111111,0xff0000,0xff0000,0x111111,0x111111,0x111111,
        0x111111,0x111111,0x111111,0xff0000,0xff0000,0xff0000,0xff0000,0xff0000,0xff0000,0xff0000,0xff0000,0x111111,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x2,0x2,0x2,0x2,0x2,0x2,0xff0000,0xff0000,0x2,0x2,0x2,0x2,0x2,0x2,0x111111,
        0x111111,0x2,0x2,0x2,0x2,0x2,0x2,0xff0000,0xff0000,0x2,0x2,0x2,0x2,0x2,0x2,0x111111,
        0x111111,0x111111,0x2,0x2,0x2,0x2,0x2,0xff0000,0xff0000,0x2,0x2,0x2,0x2,0x111111,0x111111,0x111111,
        0x111111,0x111111,0xffff00,0xffff00,0xffff00,0xffff00,0xff0000,0xff0000,0xffff00,0xffff00,0xffff00,0xffff00,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x111111,0xffff00,0xffff00,0xffff00,0xffff00,0xff0000,0xff0000,0xffff00,0xffff00,0xffff00,0xffff00,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x111111,0xffff00,0xffff00,0xffff00,0xffff00,0xff0000,0xff0000,0xffff00,0xffff00,0xffff00,0xffff00,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x111111,0xffff00,0xffff00,0xffff00,0xffff00,0xff0000,0xff0000,0xffff00,0xffff00,0xffff00,0xffff00,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x111111,0xffff00,0xffff00,0xffff00,0xffff00,0xff0000,0xff0000,0xffff00,0xffff00,0xffff00,0xffff00,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x111111,0xffff00,0xffff00,0xffff00,0xffff00,0xff0000,0xff0000,0xffff00,0xffff00,0xffff00,0xffff00,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,
        0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111
    ])
    line_4.draw_text('press A to open it')
    line_2.set_size(400)
    line_4.set_size(50)
    cyberpi.screen.render()

def open_gift():
    """Handles the gift opening animation and display."""
    global num
    line_1.hide()
    line_2.hide()
    line_4.hide()
    cyberpi.led.show('red orange yellow green cyan')
    while not cyberpi.controller.is_press('a'):
        pass

    if num == 1:
        picture_1.draw_pixels([
            0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,
            0x111111,0x111111,0x111111,0xffffff,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0xffffff,0x111111,0x111111,0x111111,0x111111,
            0x111111,0x111111,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,0x111111,0x111111,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,
            0x111111,0x111111,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,0x111111,0x111111,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,
            0x111111,0x111111,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,0x111111,0x111111,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,
            0x111111,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,0x111111,0x111111,
            0x111111,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,0x111111,0xffffff,
            0xffffff,0xffffff,0xffffff,0x0,0xffffff,0xffffff,0xffffff,0x0,0xffffff,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,0xffffff,
            0xffffff,0xffffff,0x0,0x0,0xffffff,0xffffff,0xffffff,0x0,0x0,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,0xffffff,
            0xffffff,0xffffff,0x0,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0x0,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,0xffffff,
            0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0x0,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,
            0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,0x111111,0xffffff,
            0xffffff,0xffffff,0xff0000,0xffffff,0xffffff,0xffffff,0xff0000,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,
            0xffffff,0xffffff,0xffffff,0xff0000,0xff0000,0xff0000,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,
            0x111111,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,
            0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111
        ])
        picture_1.z_max()
        picture_1.move_to(70, 74)
        picture_1.set_size(400)
    else:
        picture2.draw_pixels([
            0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0xffffff,0xffffff,0xffffff,0x111111,
            0xffffff,0x0,0x0,0x0,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0x0,0x0,0x0,0xffffff,0x111111,
            0xffffff,0x0,0x0,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0x0,0x0,0xffffff,0x111111,
            0x111111,0x0,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0x0,0x111111,0x111111,
            0xffffff,0xffffff,0xffffff,0x0,0x0,0xffffff,0xffffff,0xffffff,0x0,0x0,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0xffffff,
            0xffffff,0xffffff,0x0,0x0,0x0,0xffffff,0xffffff,0xffffff,0x0,0x0,0x0,0xffffff,0xffffff,0xffffff,0x111111,0xffffff,
            0xffffff,0xffffff,0x0,0x0,0xffffff,0xffffff,0xff0000,0xffffff,0xffffff,0x0,0x0,0xffffff,0xffffff,0xffffff,0x111111,0xffffff,
            0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0x0,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0x111111,
            0x111111,0xffffff,0xffffff,0xffffff,0x0,0xffffff,0xffffff,0x0,0xffffff,0xffffff,0x0,0xffffff,0xffffff,0xffffff,0x111111,0x111111,
            0x111111,0x111111,0xffffff,0xffffff,0xffffff,0x0,0x0,0x0,0x0,0x0,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,
            0x111111,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,0x111111,
            0x111111,0x111111,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0xffffff,0x111111,0x111111,0x111111,0x111111,
            0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,
            0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,
            0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,
            0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111,0x111111
        ])
        picture2.z_max()
        picture2.move_to(70, 74)
        picture2.set_size(400)
    cyberpi.screen.render()

# --- Event Handlers ---
@event.start
def on_start():
    """Initial setup when the CyberPi program starts."""
    global num
    cyberpi.sketch.clear()
    location()
    screen1()
    color()
    size()
    cyberpi.screen.render()
    cyberpi.wifi_broadcast.start() # Moved WiFi start here to be part of initial setup

@event.is_shake
def on_is_shake():
    """Handles actions when the CyberPi is shaken."""
    cyberpi.broadcast_and_wait('giftShaken')
    cyberpi.wifi_broadcast.set('giftShaken', 0) # Consider if this reset is always desired after each shake

@cyberpi.event.wifi_broadcast('giftShaken')
def on_wifi_broadcast_gift_received():
    """Handles actions when a 'giftShaken' broadcast is received."""
    line_1.move_to(64, 30) # Adjust position for received gift screen
    line_2.move_to(64, 74) # Adjust position for received gift screen

    # Play magic sound and flash LEDs
    for _ in range(4): # Use underscore for unused loop variable
        cyberpi.audio.play('magic')
        cyberpi.led.on(255, 0, 0, "all")
        time.sleep(0.15)
        cyberpi.led.on(0, 0, 0, "all")
        time.sleep(0.15) # Only one off state needed

    if cyberpi.get_language() == 'chinese':
        screen2_Chinese()
    else:
        screen2_English()
    open_gift()
